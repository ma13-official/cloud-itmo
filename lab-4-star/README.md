# Работа с секретами через HashiCorp Vault

В этой работе мы рассмотрели процесс работы с секретами через HashiCorp Vault, который является безопасным и удобным инструментом для хранения и управления конфиденциальной информацией, такой как пароли, API-ключи, сертификаты и другое

## Поднятие HashiCorp Vault

Для начала нам нужно поднять HashiCorp Vault с помощью Docker. Мы использовали команду:

```bash
docker-compose up -d
```

![image](https://github.com/user-attachments/assets/e30fb982-60e8-4ef1-a9e7-8d3cddbdfddf)

## Вход в Vault

После того как контейнер с Vault поднят, нужно войти в систему с использованием токена root. Это можно сделать с помощью команды:

```bash
vault login root
```

Но здесь возникла первая  **трудность**. Появилась следующая ошибка:

Error authenticating: error looking up token: Get "https://127.0.0.1:8200/v1/auth/token/lookup-self": http: server gave HTTP response to HTTPS client

Это связано с тем, что клиент Vault ожидает соединения через HTTPS, а я использовал HTTP, нужно указать явно, что Vault должен использовать HTTP:

```bash
vault login -address=http://127.0.0.1:8200 root
```
![image](https://github.com/user-attachments/assets/b1dc2e7f-d2d3-4ecb-aad2-df921b0aff80)

 **Success!**

![image](https://github.com/user-attachments/assets/7b08b05a-d71f-4eb0-9d17-dc71da7af125)

## Добавление секретов в Vault

После входа в систему мы создали секреты, которые будут храниться в Vault. Для этого использовали команду:

```bash
vault kv put secret/myapp DB_USER=myuser DB_PASSWORD=mypassword
```

Эти секреты включают в себя имя пользователя и пароль для приложения, которые теперь можно безопасно хранить в Vault, с помощью команды vault kv get можно получить значения секретов:

```bash
vault kv get -address=http://127.0.0.1:8200 secret/myapp
```

Для создания токена с нужными правами доступа использовали команду:

```bash
vault token create -address=http://127.0.0.1:8200 -policy=root
```

![image](https://github.com/user-attachments/assets/26b28d5d-8b61-4ffc-9d95-a2158711df02)

Этот токен может быть использован для авторизации и доступа к секретам

В браузере можно перейти по адресу http://localhost:8200/ui/vault/secrets/secret/kv/myapp/ и просмотреть секреты

## Интеграция с сервисом

Так как Vault развернут локально, а не где-то в интернете, то достучаться до него из этих ваших пайплайнов просто не получится. Если бы он использовался на корпоративном сервере и на этом же сервере был развернут гитлаб - никаких проблем. Вообще можно было бы конечно прокинуть туннель, но мне показалось, что проще настроить получение секретов из питона :)

Итак, был создан файл [get_secrets.py](./get_secrets.py). Для работы необходимо установить библиотеку `hvac` (в работе использовался `Python 3.10.11` и `hvac 2.3.0`) - это специальная библиотека для работы с vault.

Иронично, что для получения секретов нужно иметь некоторый секрет - в переменные окружения был сохранен `VAULT_TOKEN`.

Далее нужно узнать путь наших секретов - его можно подглядеть на странице http://localhost:8200/ui/vault/secrets/secret/kv/myapp/paths.

![image](https://github.com/user-attachments/assets/b25158b5-9e0a-46da-b7c9-3f40b79bc0ea)

Как оказалось, часть `/v1/secret` подставляется автоматически, значит наш путь - `/data/myapp`.

Путем сложных обращений к разным объектам таки был получен доступ к функции read_secret - указываем наш путь и вуаля! Получаем ответ от Vault.

![image](https://github.com/user-attachments/assets/09acfe55-4170-490f-b291-ac886c97faf2)

Почему нужно дважды обратиться по ключу data? Первое обращение - тело ответа от vault, второе - обращение к самим секретам (здесь можно получить метаданные).

## Вывод
В ходе выполнения данной практической работы был поднят Hashicorp Vault. Его использование для хранения секретов обеспечивает высокий уровень безопасности, а также удобство управления секретами в различных сервисах и приложениях. В отличие от хранения секретов в CI/CD переменных репозитория, Vault предоставляет централизованный и безопасный способ работы с конфиденциальной информацией, минимизируя риски утечек и неправильного использования данных.

Хорошего дня, удачного вечера, балдёжного времяпрепровождения, всем удачи, счастья, балдежа, всем пока, всего наилучшего. Спасибо за поддержку, спасибо за понимание, спасибо за хорошие комментарии, спасибо за плохие комментарии, спасибо за лайки, спасибо за дизлайки. Я всем рад и всем доволен
